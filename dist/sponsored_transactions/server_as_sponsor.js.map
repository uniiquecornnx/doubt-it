{"version":3,"sources":["../../sponsored_transactions/server_as_sponsor.ts"],"sourcesContent":["/* eslint-disable no-console */\n\n/**\n * This example demostrates how one can use an external server\n * as a sponsor to sign a transaction to eventually pay the gas fees.\n *\n * A server (for example, frontend) generates a transaction, have it serialized and send\n * it to another server (for example, backend) to deserialize and signs as the sponsor,\n * then sends it back to the other server (the frontend server) to submit the transaction.\n */\n\nimport {\n  Account,\n  AccountAuthenticator,\n  Aptos,\n  AptosConfig,\n  Deserializer,\n  Network,\n  NetworkToNetworkName,\n  SimpleTransaction,\n} from \"@aptos-labs/ts-sdk\";\n\nconst INITIAL_BALANCE = 100_000_000;\nconst TRANSFER_AMOUNT = 100;\n\n// Default to devnet, but allow for overriding\nconst APTOS_NETWORK: Network = NetworkToNetworkName[process.env.APTOS_NETWORK] || Network.DEVNET;\n// Setup the client\nconst config = new AptosConfig({ network: APTOS_NETWORK });\nconst aptos = new Aptos(config);\n\n// The sponsor server gets the serialized transaction to sign as the fee payer\nconst sendToTheSponsorServer = async (transactionBytes: Uint8Array) => {\n  const sponsor = Account.generate();\n  console.log(`Sponsor's address is: ${sponsor.accountAddress}`);\n  await aptos.fundAccount({ accountAddress: sponsor.accountAddress, amount: INITIAL_BALANCE });\n\n  // deserialize raw transaction\n  const deserializer = new Deserializer(transactionBytes);\n  const transaction = SimpleTransaction.deserialize(deserializer);\n\n  // Sponsor signs\n  const sponsorAuth = aptos.transaction.signAsFeePayer({\n    signer: sponsor,\n    transaction,\n  });\n\n  const sponsorAuthBytes = sponsorAuth.bcsToBytes();\n\n  return { sponsorAuthBytes, signedTransaction: transaction };\n};\n\nconst example = async () => {\n  // Create two accounts\n  const alice = Account.generate();\n  const bob = Account.generate();\n\n  console.log(\"=== Addresses ===\\n\");\n  console.log(`Alice's address is: ${alice.accountAddress}`);\n  console.log(`Bob's address is: ${bob.accountAddress}`);\n\n  // Fund the accounts\n  console.log(\"\\n=== Funding accounts ===\\n\");\n\n  await aptos.fundAccount({\n    accountAddress: alice.accountAddress,\n    amount: INITIAL_BALANCE,\n  });\n\n  console.log(\"\\n=== Accounts funded ===\\n\");\n\n  const transaction = await aptos.transaction.build.simple({\n    sender: alice.accountAddress,\n    withFeePayer: true,\n    data: {\n      function: \"0x1::aptos_account::transfer\",\n      functionArguments: [bob.accountAddress, TRANSFER_AMOUNT],\n    },\n  });\n\n  // Alice signs\n  const senderAuth = aptos.transaction.sign({ signer: alice, transaction });\n\n  // Send the serialized transaction to the sponsor server to sign\n  const { sponsorAuthBytes, signedTransaction } = await sendToTheSponsorServer(transaction.bcsToBytes());\n\n  // deserialize fee payer authenticator\n  const deserializer = new Deserializer(sponsorAuthBytes);\n  const feePayerAuthenticator = AccountAuthenticator.deserialize(deserializer);\n\n  const response = await aptos.transaction.submit.simple({\n    transaction: signedTransaction,\n    senderAuthenticator: senderAuth,\n    feePayerAuthenticator,\n  });\n\n  const executedTransaction = await aptos.waitForTransaction({ transactionHash: response.hash });\n  console.log(\"executed transaction\", executedTransaction.hash);\n};\n\nexample();\n"],"mappings":";AAWA;AAAA,EACE;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,OACK;AAEP,IAAM,kBAAkB;AACxB,IAAM,kBAAkB;AAGxB,IAAM,gBAAyB,qBAAqB,QAAQ,IAAI,aAAa,KAAK,QAAQ;AAE1F,IAAM,SAAS,IAAI,YAAY,EAAE,SAAS,cAAc,CAAC;AACzD,IAAM,QAAQ,IAAI,MAAM,MAAM;AAG9B,IAAM,yBAAyB,OAAO,qBAAiC;AACrE,QAAM,UAAU,QAAQ,SAAS;AACjC,UAAQ,IAAI,yBAAyB,QAAQ,cAAc,EAAE;AAC7D,QAAM,MAAM,YAAY,EAAE,gBAAgB,QAAQ,gBAAgB,QAAQ,gBAAgB,CAAC;AAG3F,QAAM,eAAe,IAAI,aAAa,gBAAgB;AACtD,QAAM,cAAc,kBAAkB,YAAY,YAAY;AAG9D,QAAM,cAAc,MAAM,YAAY,eAAe;AAAA,IACnD,QAAQ;AAAA,IACR;AAAA,EACF,CAAC;AAED,QAAM,mBAAmB,YAAY,WAAW;AAEhD,SAAO,EAAE,kBAAkB,mBAAmB,YAAY;AAC5D;AAEA,IAAM,UAAU,YAAY;AAE1B,QAAM,QAAQ,QAAQ,SAAS;AAC/B,QAAM,MAAM,QAAQ,SAAS;AAE7B,UAAQ,IAAI,qBAAqB;AACjC,UAAQ,IAAI,uBAAuB,MAAM,cAAc,EAAE;AACzD,UAAQ,IAAI,qBAAqB,IAAI,cAAc,EAAE;AAGrD,UAAQ,IAAI,8BAA8B;AAE1C,QAAM,MAAM,YAAY;AAAA,IACtB,gBAAgB,MAAM;AAAA,IACtB,QAAQ;AAAA,EACV,CAAC;AAED,UAAQ,IAAI,6BAA6B;AAEzC,QAAM,cAAc,MAAM,MAAM,YAAY,MAAM,OAAO;AAAA,IACvD,QAAQ,MAAM;AAAA,IACd,cAAc;AAAA,IACd,MAAM;AAAA,MACJ,UAAU;AAAA,MACV,mBAAmB,CAAC,IAAI,gBAAgB,eAAe;AAAA,IACzD;AAAA,EACF,CAAC;AAGD,QAAM,aAAa,MAAM,YAAY,KAAK,EAAE,QAAQ,OAAO,YAAY,CAAC;AAGxE,QAAM,EAAE,kBAAkB,kBAAkB,IAAI,MAAM,uBAAuB,YAAY,WAAW,CAAC;AAGrG,QAAM,eAAe,IAAI,aAAa,gBAAgB;AACtD,QAAM,wBAAwB,qBAAqB,YAAY,YAAY;AAE3E,QAAM,WAAW,MAAM,MAAM,YAAY,OAAO,OAAO;AAAA,IACrD,aAAa;AAAA,IACb,qBAAqB;AAAA,IACrB;AAAA,EACF,CAAC;AAED,QAAM,sBAAsB,MAAM,MAAM,mBAAmB,EAAE,iBAAiB,SAAS,KAAK,CAAC;AAC7F,UAAQ,IAAI,wBAAwB,oBAAoB,IAAI;AAC9D;AAEA,QAAQ;","names":[]}